#!/bin/bash

set -ex

if [ $# -eq 1 ]; then
    NODE_NUM=$1
else
    NODE_NUM=5
fi
echo $NODE_NUM

RPC_USER=${RPCUSER:-bitcoinrpc}
RPC_PASSWORD=${RPCPASSWORD:-`dd if=/dev/urandom bs=33 count=1 2>/dev/null | base64`}
BITCOIND_PORT_BASE=${BITCOIND_PORT_BASE:-23000}
RPC_PORT_BASE=${RPC_PORT_BASE:-23100}

for ((i=${NODE_NUM}; $i > 0; i=$(($i-1))));do
    BITCOIND_PORT=$((${BITCOIND_PORT_BASE}+$i))
    RPC_PORT=$((${RPC_PORT_BASE}+$i))
    DATADIR=$HOME/regtest/$i/
    mkdir -p ${DATADIR}

    if (($i > 1));then
        CONNECT_PORT=$((${BITCOIND_PORT}-1))
        DAEMON="-daemon"
    else
        CONNECT_PORT=$((${BITCOIND_PORT_BASE}+${NODE_NUM}))
        DAEMON=""
    fi

    bitcoind -server -listen -regtest ${DAEMON} -debug \
        -port=${BITCOIND_PORT} -connect=${CONNECT_PORT} \
        -rpcport=${RPC_PORT} -rpcuser=${RPC_USER} -rpcpassword=${RPC_PASSWORD} \
        -rpcallowip=0.0.0.0/0 -rpcallowip=::/0 \
        -datadir=${DATADIR} -pid=${DATADIR}/.pid
done
